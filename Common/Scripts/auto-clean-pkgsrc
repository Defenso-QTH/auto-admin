#!/bin/sh -e

##########################################################################
#   Script description:
#       
#   Arguments:
#       
#   Returns:
#       
#   History:
#   Date        Name        Modification
#   2015-05-13  root        Begin
##########################################################################

usage()
{
    printf "Usage: $0 [prefix]\n"
    exit 1
}


##########################################################################
#   Main
##########################################################################

case $# in
0)
    prefix=/usr/pkgsrc
    ;;
1)
    prefix="$1"
    ;;
*)
    usage
    ;;
esac

printf "Cleaning $prefix...\n"
cd "$prefix"

if [ `uname` = Linux ]; then
    flags=-Pm
else
    flags=-m
fi

before=`df $flags . | awk '$1 != "Filesystem" { print $4 }'`

for dir in */*/work; do
    printf "$dir\n"
    rm -rf $dir
done

printf "Remove distfiles? y/[n] "
read dist
if [ 0$dist = 0y ]; then
    rm -rf distfiles/*
fi

after=`df $flags . | awk '$1 != "Filesystem" { print $4 }'`
printf "Initial free space: %d\n" $before
printf "Final free space: %d\n" $after
diff=$(($after - $before))
printf "%d megabytes freed.\n" $diff

