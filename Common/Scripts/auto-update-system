#!/bin/sh -e

os_type=`uname`

case $os_type in
FreeBSD)
    printf "Update installed packages? [y]/n "
    read update_packages
    printf "Update ports tree? [y]/n "
    read update_ports
    printf "Update base system? [y]/n "
    
    read update_base
    if [ 0$update_packages != 0n ]; then
	pkg update -f
	pkg clean -y
	pkg upgrade -y
	pkg clean -y
    fi
    
    if [ 0$update_ports != 0n ]; then
	# --interactive is only supported on 10.x
	portsnap fetch
	if [ -e /usr/ports/CHANGES ]; then
	    portsnap update
	else
	    portsnap extract
	fi
    fi
    
    if [ 0$update_base != 0n ]; then
	tmpfile=update-system.tmp
	freebsd-update --not-running-from-cron fetch | tee $tmpfile
	
	if ! fgrep -q 'No updates' $tmpfile; then
	    freebsd-update --not-running-from-cron install
	fi
	rm $tmpfile
    fi
    ;;

Linux)
    # Complete interrupted yum updates if the tool is installed and there
    # are any
    yum-complete-transaction || true
    
    # FIXME: Add clean-up commands?
    yum update
    ;;
    
*)
    printf "Error: $os_type is not yet supported.\n"
    exit 1
esac

printf "Reboot? [y]/n "
read reboot
if [ 0$reboot != 0n ]; then
    shutdown -r now
fi

